{% extends "base.html" %}
{% load static %}

{% block title %}{{ parrilla.nombre }} - ChoriFans{% endblock %}

{% block content %}
  <div class="parrilla-detalle-container">
    <h1 class="parrilla-detalle-titulo">
      {{ parrilla.nombre }}
    </h1>

    <div class="parrilla-detalle-layout">
      <div class="parrilla-detalle-foto">
        {# Si la parrilla tiene foto_principal, mostramos esa imagen.Si NO tiene, mostramos una imagen por defecto (sin-foto.png)ubicada en static/css/sin-foto.png#}
        {% if parrilla.foto_principal %}
          <img
            src="{{ parrilla.foto_principal.url }}"
            alt="Foto de {{ parrilla.nombre }}"
            class="parrilla-detalle-img"
          />
        {% else %}
          <img
            src="{% static 'css/img/sin-foto.png' %}"
            alt="Foto no disponible de {{ parrilla.nombre }}"
            class="parrilla-detalle-img parrilla-detalle-img--placeholder"
          />
        {% endif %}
      </div>

      <div class="parrilla-detalle-info">
        <p><strong>Direcci√≥n:</strong> {{ parrilla.direccion }}</p>

        {% if parrilla.telefono %}
          <p><strong>Tel√©fono:</strong> {{ parrilla.telefono }}</p>
        {% endif %}

        {% if parrilla.sitio_web %}
          <p>
            <strong>Sitio web:</strong>
            <a href="{{ parrilla.sitio_web }}" target="_blank" rel="noopener noreferrer">
              {{ parrilla.sitio_web }}
            </a>
          </p>
        {% endif %}

        <p>
          <strong>Ubicaci√≥n:</strong>
          {{ parrilla.ubicacion.nombre_barrio }} - {{ parrilla.ubicacion.nombre_ciudad }}
        </p>

        <p>
          <strong>Categor√≠a:</strong>
          {{ parrilla.categoria.nombre }}
        </p>

        <p>
          <strong>Descripci√≥n:</strong><br />
          {{ parrilla.descripcion }}
        </p>

        <div class="puntaje-promedio-iconos">
          {% with puntaje=parrilla.promedio_puntaje|default:0 %}
            {% with entero=puntaje|floatformat:0 %}
              {% for i in "12345" %}
                {% if forloop.counter <= entero|add:"0" %}
                  <span class="chori chori--lleno">üå≠</span>
                {% else %}
                  <span class="chori chori--gris">üå≠</span>
                {% endif %}
              {% endfor %}
            {% endwith %}
          {% endwith %}
        </div>

      </div>
    </div>

    <!-- Rese√±as de la parrilla -->
    <div class="parrilla-detalle-resenas">
      <h2 class="parrilla-detalle-subtitulo">
        Rese√±as de la comunidad
      </h2>

      {% if resenas %}
        <ul class="resenas-lista">
          {% for r in resenas %}
            <li class="resena-item">
              <div class="resena-header">
                <span class="resena-puntaje">
                  {{ r.get_puntaje_display }}
                </span>
                <span class="resena-usuario">
                  por {{ r.usuario.username }}
                </span>
                <span class="resena-fecha">
                  {{ r.created_at|date:"d/m/Y H:i" }}
                </span>
              </div>

              <p class="resena-comentario">
                {{ r.comentario }}
              </p>

              {# Si la parrilla respondi√≥ esta rese√±a, mostramos la mini-card debajo #}
              {% if r.respuesta_parrilla %}
                <div class="respuesta-parrilla-card respuesta-parrilla-card--detalle">
                  <div class="respuesta-header">
                    <span class="respuesta-nombre-parrilla">
                      {{ r.parrilla.nombre|upper }}
                    </span>

                    <img
                      src="{% static 'css/img/verified.png' %}"
                      alt="Cuenta verificada"
                      class="respuesta-verificado-icon"
                    />

                    <span class="respuesta-valoracion">
                      {% if r.respuesta_parrilla.valoracion == "happy" %}
                        üòä
                      {% else %}
                        ‚òπÔ∏è
                      {% endif %}
                    </span>

                  </div>

                  <p class="respuesta-texto">
                    {{ r.respuesta_parrilla.texto }}
                  </p>

                  <p class="respuesta-meta">
                    Respuesta oficial ¬∑
                    {{ r.respuesta_parrilla.updated_at|date:"d/m/Y H:i" }}
                  </p>
                </div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="resena-empty">
          No hay rese√±as todav√≠a. ¬°S√© el primero en opinar!
        </p>
      {% endif %}
    </div>

    <!-- Promociones vigentes -->
    <div class="parrilla-detalle-promos">
      <h2 class="parrilla-detalle-subtitulo">
        Promociones vigentes
      </h2>

      {% if promociones %}
        <ul class="promos-lista">
          {% for promo in promociones %}
            <li class="promo-item">
              <div class="promo-header">
                <h3 class="promo-titulo">{{ promo.titulo }}</h3>

                {% if promo.precio_promocional %}
                  <span class="promo-precio">
                    $ {{ promo.precio_promocional }}
                  </span>
                {% endif %}
              </div>

              <p class="promo-descripcion">
                {{ promo.descripcion }}
              </p>

              <p class="promo-fechas">
                V√°lida del {{ promo.fecha_inicio|date:"d/m/Y" }}
                al {{ promo.fecha_fin|date:"d/m/Y" }}
              </p>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="promo-empty">
          No hay promociones vigentes para esta parrilla en este momento.
        </p>
      {% endif %}
    </div>

    {# Formulario para dejar rese√±a: solo para usuarios que NO son due√±os de parrilla #}
    {% if not es_duenio_parrilla %}
      <div class="resena-formulario">
        <h2 class="parrilla-detalle-subtitulo resena-formulario-titulo">
          Tu rese√±a
        </h2>

        {% if user.is_authenticated %}

          {% if ya_rese√±o %}
            <p class="resena-ya-hecha">
              Ya dejaste una rese√±a para esta parrilla üòä
            </p>

          {% elif puede_rese√±ar %}
            <form method="POST" class="resena-form form--crear-resena">
              {% csrf_token %}

              <div class="resena-form-row">
                <label for="{{ form.puntaje.id_for_label }}" class="resena-form-label">
                  Puntaje:
                </label>
                {{ form.puntaje }}
                <p class="resena-help-text">
                  Eleg√≠ de 1 a 5 choripanes (1 = peor, 5 = mejor).
                </p>
              </div>

              <div class="resena-form-row">
                <label for="{{ form.comentario.id_for_label }}" class="resena-form-label">
                  Comentario:
                </label>
                {{ form.comentario }}
                <p class="resena-help-text">
                  Comentario del usuario sobre la parrilla.
                </p>
              </div>

              <div class="resena-form-acciones">
                <button type="submit" class="btn btn-primary">
                  Publicar rese√±a
                </button>
              </div>
            </form>
          {% endif %}

        {% else %}
          <p class="resena-login-msg">
            Para dejar una rese√±a necesit√°s
            <a href="{% url 'accounts:login' %}">iniciar sesi√≥n</a>.
          </p>
        {% endif %}
      </div>
    {% endif %}

    <p class="volver-box">
      <a href="{% url 'home' %}" class="volver-btn">
        ‚Üê Inicio
      </a>
    </p>

  </div>
{% endblock %}
